# S1F Test Suite

Comprehensive test suite for the s1f (Split One File) tool with 6 test files and ~40 test methods, covering extraction, encoding, and security features.

## ðŸ“ Test Structure

```
tests/s1f/
â”œâ”€â”€ README.md                          # This file
â”œâ”€â”€ conftest.py                        # s1f-specific test fixtures
â”‚
â”œâ”€â”€ Core Tests
â”‚   â”œâ”€â”€ test_s1f_basic.py             # Core extraction functionality
â”‚   â”œâ”€â”€ test_s1f.py                   # General functionality tests
â”‚   â””â”€â”€ test_s1f_async.py             # Asynchronous operations
â”‚
â”œâ”€â”€ Encoding Tests
â”‚   â”œâ”€â”€ test_s1f_encoding.py          # Character encoding preservation
â”‚   â””â”€â”€ test_s1f_target_encoding.py   # Encoding conversion tests
â”‚
â”œâ”€â”€ Security Tests
â”‚   â””â”€â”€ test_path_traversal_security.py # Path traversal protection
â”‚
â””â”€â”€ Test Resources
    â”œâ”€â”€ output/                        # Pre-generated M1F bundles
    â”œâ”€â”€ extracted/                     # Extraction target directory
    â””â”€â”€ source/                        # Source files for testing
```

## ðŸ§ª Test Categories

### 1. **Core Functionality**

**Basic Extraction** (`test_s1f_basic.py`):
- âœ… All M1F separator styles (Standard, Detailed, Markdown, MachineReadable)
- âœ… File path preservation
- âœ… Directory structure reconstruction
- âœ… Content integrity verification
- âœ… Metadata extraction
- âœ… Force overwrite (`-f`) option
- âœ… Timestamp handling

**General Operations** (`test_s1f.py`):
- ðŸ“‹ Command-line interface testing
- ðŸ” Format auto-detection
- ðŸ“ Output directory creation
- âš ï¸ Error handling
- ðŸ“Š Statistics reporting

**Async Operations** (`test_s1f_async.py`):
- âš¡ Asynchronous file extraction
- ðŸ”€ Concurrent processing
- ðŸ“ˆ Performance optimization
- ðŸ’¾ Memory efficiency

### 2. **Encoding & Character Handling**

**Encoding Preservation** (`test_s1f_encoding.py`):
- ðŸ”¤ UTF-8, UTF-16, Latin-1 preservation
- ðŸŒ Exotic encoding support
- ðŸ’¾ BOM handling
- âœ… Binary file extraction
- ðŸ“ Encoding metadata

**Target Encoding** (`test_s1f_target_encoding.py`):
- ðŸ”„ Encoding conversion during extraction
- ðŸŽ¯ Target encoding specification
- âš ï¸ Conversion error handling
- ðŸ“Š Encoding statistics

### 3. **Security Features**

**Path Traversal Protection** (`test_path_traversal_security.py`):
- ðŸ›¡ï¸ Path traversal attack prevention
- ðŸ“ Malicious path sanitization
- ðŸ”’ Sandbox enforcement
- âš ï¸ Security warnings
- âœ… Safe path validation

## ðŸ§ª Test Fixtures (conftest.py)

**Core Fixtures:**
- `s1f_output_dir` - Output directory with auto-cleanup
- `s1f_extracted_dir` - Extraction directory
- `create_combined_file` - Creates test M1F files
- `run_s1f` - Direct function testing
- `s1f_cli_runner` - Subprocess CLI testing
- `create_m1f_output` - Uses real M1F tool for test input

**Separator Styles:**
- Standard: `############ filename ############`
- Detailed: `### START: filename ###`
- Markdown: `## filename`
- MachineReadable: JSON metadata format

## ðŸš€ Running Tests

### Run All S1F Tests
```bash
pytest tests/s1f/ -v
```

### Run Specific Categories
```bash
# Core functionality
pytest tests/s1f/test_s1f_basic.py -v

# Encoding tests
pytest tests/s1f/test_*encoding*.py -v

# Security tests
pytest tests/s1f/test_*security*.py -v

# Async tests
pytest tests/s1f/test_*async*.py -v
```

### Run with Options
```bash
# Show output
pytest tests/s1f/ -s

# Stop on first failure
pytest tests/s1f/ -x

# Verbose with full diff
pytest tests/s1f/ -vv

# Run specific test
pytest tests/s1f/test_s1f_basic.py::test_extract_standard -v
```

## ðŸ“Š Test Coverage

**Core Features:**
- All M1F format variations
- Path preservation accuracy
- Content integrity (SHA-256)
- Metadata handling

**Edge Cases:**
- Empty files
- Binary files
- Large files
- Nested directories
- Special characters
- Unicode filenames

**Error Handling:**
- Corrupted M1F files
- Missing separators
- Invalid paths
- Encoding errors

## ðŸ§ª Test Data

### Pre-generated M1F Files
The test suite uses pre-generated M1F bundles in various formats:
```bash
output/standard.txt       # Standard separator style
output/detailed.txt       # Detailed separator style
output/markdown.txt       # Markdown separator style
output/machinereadable.txt # JSON metadata style
```

### Creating Test Data
Test data is automatically generated by fixtures using the real M1F tool:
```python
# Example from conftest.py
def create_m1f_output(source_dir, output_file, separator_style):
    """Creates M1F bundle for testing."""
    result = subprocess.run([
        "m1f",
        str(source_dir),
        "-o", str(output_file),
        "--separator-style", separator_style,
        "--force"
    ])
```

## ðŸ“ Writing New Tests

### Test Template
```python
from __future__ import annotations

import pytest
from pathlib import Path

class TestNewFeature:
    """Tests for new s1f feature."""
    
    @pytest.mark.unit
    def test_feature(self, run_s1f, create_combined_file):
        """Test description."""
        # Arrange
        m1f_file = create_combined_file(
            "test.txt", 
            "content",
            separator_style="Standard"
        )
        
        # Act
        result = run_s1f([
            str(m1f_file),
            "-o", "output_dir"
        ])
        
        # Assert
        assert result.returncode == 0
        assert Path("output_dir/test.txt").exists()
```

### Best Practices
1. **Use fixtures** - Don't create M1F files manually
2. **Test all formats** - Verify with all separator styles
3. **Verify integrity** - Check content matches original
4. **Clean paths** - Fixtures handle cleanup
5. **Cross-platform** - Consider path separators

## ðŸ”§ Troubleshooting

### Common Issues

**Format Detection:**
- Ensure M1F files have correct separators
- Check for file corruption
- Verify encoding compatibility

**Path Issues:**
- Windows path length limits
- Case sensitivity differences
- Path separator normalization

**Encoding Problems:**
- System locale settings
- Missing codec support
- BOM handling

### Debug Commands
```bash
# Run with debugging
pytest tests/s1f/ --pdb

# Check test output
pytest tests/s1f/ -s --log-cli-level=DEBUG

# Run single test with tracing
pytest tests/s1f/test_s1f_basic.py::test_extract_standard -vvs
```

## ðŸ›¡ï¸ Security Testing

The test suite includes security tests for:
- Path traversal attempts (`../../../etc/passwd`)
- Absolute path injections
- Symbolic link attacks
- Directory escape attempts

## ðŸš€ Performance

- Tests use async I/O where applicable
- Parallel extraction support
- Memory-efficient streaming
- Large file handling

## ðŸ› ï¸ Maintenance

- **Test data** - Regenerate M1F files after format changes
- **Fixtures** - Keep fixtures simple and focused
- **Coverage** - Maintain >90% code coverage
- **Performance** - Monitor test execution time
